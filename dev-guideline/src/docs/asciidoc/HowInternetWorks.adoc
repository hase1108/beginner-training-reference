include::include_all.adoc[]

:toclevels: 5
:sectnums:

[HowInterWorks]
= インターネットの仕組み

[[HowInterWorks_Overview]]
== Overview
今日のシステム開発においては、単純に知識の収集のみならず、ライブラリの取得やインターネットを通じた遠隔サーバや各種サービスへの接続など、インターネットの利用が不可欠となっている。 +
本節ではそのインターネットがどのような仕組みで成立しているか概要を解説する。 +

[[HowInterWorks_Internet]]
== ネットワーク/インターネットとは

複数のコンピュータ(PC-PCやPC-サーバ)などを接続したシステムを総称して**ネットワーク**と呼ばれる。 +
対してインターネットは、そのネットワークを相互に接続し、全世界をカバーした情報通信網である。  +
概略図を以下に示す。

.インターネットの構成
[#internet-components]
image::HowInternetWorks/InternetComponent.png[インターネットの構成]

[[HowInterWorks_Internet_LAN]]
=== LAN(Local Area Network)
LANはネットワークを構成する最小単位で、そのネットワークは通常大きくとも一施設の範囲に収まることが多い。 +
ルータを用いて外部のインターネットに接続することもできるが、外部インターネットに接続せず、閉域網として内部に社内ポータルやデータベースをセキュアに保持することができる。

[[HowInterWorks_Internet_WAN]]
=== WAN(Wide Area Network)
LAN同士を相互に接続したものをWANと呼ぶ。接続されたLANは必ずしも地理的に隣接するものではない。 +
プロバイダーなどを通じて外部のWANと相互に接続したものをインターネットということもできる。 +
WANを直接インターネットに接続せず、ある組織内におけるプライベートネットワークとしたものをインターネットと比較し``イントラネット``と呼称することもある。 +
この場合、外部のインターネットと接続する部分に``プロキシサーバ``を建て、外部と通信する際に監視とフィルタリングをする場合が多い。  

[[HowInterWorks_Communication]]
== ネットワーク通信手法
<<_HowInterWorks_Internet,ネットワーク/インターネットとは>>で説明したように、ネットワークは複数の機器を接続した構造をし、インターネットはそれを全世界に広げたものになる。 +
この時、接続された機器の間では好き勝手なルールでは通信が成立しないため、共通したルール(**プロトコル**)で通信を行う。 +
ネットワークを構築するにあたり、考慮するプロトコルは非常に多いため、階層構造としてまとめて記述したものとして、**OSI参照モデル**および現在のインターネットのデファクトともいえるTCP/IPを基準とした**TCP/IPモデル(インターネトプロトコルスイート)**というモデルが存在する。 +
両モデルは同じような階層構造をしており、共通する部分も多いが作成した母体などが異なるため、必ずしも一致しない。 +
業務上TCP/IPモデルを押さえておけばよいことが多いため、本解説では主にTCP/IPモデルを利用して説明を行う。 +
以下に双方のモデルの概要図を示す。

.インターネットモデル概要図
[#internet-model]
image::HowInternetWorks/InternetModel.png[インターネットモデル概要図]

.OSI参照モデルの階層構造
[cols="10,30,60", options="header"]
|===
|項番
|名称
|概要

|1-1
|アプリケーション層
|ファイルの転送やDBアクセスなど具体的な通信サービスを提供する

|1-2
|プレゼンテーション層
|データの表現方法を制御する

|1-3
|セッション層
|通信の開始から終了や接続の回復方法などを規定する

|1-4
|トランスポート層
|通信時のエラー訂正や再送制御などを規定する

|1-5
|ネットワーク層
|データをどこに送信するかを選択する

|1-6
|データリンク層
|ネットワーク的に隣接する機器への信号の受け渡し方式を規定する

|1-7
|物理層
|イーサネットなどネットワークに接続するための物理的な方式や機構を規定する
|===

.TCP/IPモデルの階層構造
[cols="10,30,60", options="header"]
|===
|項番
|名称
|概要

|2-1
|アプリケーション層
|ファイルの転送やDBの接続など、具体的な通信サービスを提供する

|2-2
|トランスポート層
|主にTCPなど通信方式をつかさどるレイヤ

|2-3
|インターネット層
|主にIPなどの通信相手の決定を行うレイヤ

|2-4
|リンク層
|ネットワークへの接続方式を規定するレイヤ
|===

[[HowInterWorks_Communication_Protcol]]
=== プロトコルの詳細
各TCP/IPモデルの中のプロトコルで、実務上意識することの多いものをピックアップして紹介する。 +
リンク層に位置するプロトコルは意識をすることが少ないため省略する。

[[HowInterWorks_Communication_Protcol_Internet]]
==== インターネット層

[[HowInterWorks_Communication_Protcol_Internet_IP]]
===== IP
IPはTCP/IPモデルの名称となっているように、インターネット通信の基本的なプロトコルの一つである。 +
このプロトコルでは、ネットワークに接続された機器に対して**IPアドレス**という数字を付与し、その数字を使用して通信時に相手を指定、呼び出しができるようにすることを規定している。 +

IPアドレスは、アドレスの振り分け方式により主に2つに分けられる。 +
現在最も普及しているのは、8bitの数字を4つ繋げ、``0.0.0.0～255.255.255.255``の計32bit約43億までのアドレスを表現できる**IPv4**と、IPv4によるアドレスの枯渇が生じたために考えられ、16bitを8つ、``0:0:0:0:0:0:0:0～ffff:ffff:ffff:ffff:ffff:ffff:ffff``の計128bit約340潤のアドレスを表現できる**IPv6**が存在する。 +

どちらにしても、IPでは付与された数字をインターネットにおける住所のように取り扱うことで、接続先を特定することができる。 +
例えば``www.google.co.jp``のIPアドレスは``172.217.161.35``であるため、ブラウザのアドレスバーでIPアドレスを入力するとgoogleのページを開くことができる。 +
他にもコマンドプロンプトやシェルなどでは``ping``コマンドを利用することで、以下の画像のように対象のIPアドレスに対するアクセス状況を確認することができる。 +

.pingコマンド
[#internet-model]
image::HowInternetWorks/ping.png[pingコマンド]

pingコマンドは特定のサーバなどから応答が帰ってこないなどの場合に原因を特定するための手掛かりにもなる。 +

また、一部のIPアドレスは特定の用途の為に占有されており、**予約アドレス**と呼ばれる。詳細は<<HowInterWorks_Communication_Protcol_Internet_IP_Subnet,サブネット>>で説明する。 +

[[HowInterWorks_Communication_Protcol_Internet_IP_Routing]]
====== IPによるルーティング
前述したように、IPアドレスはインターネット上の住所のように取り扱うが、実際に通信を行う際はどの通信経路を使用すれば目的のIPアドレスに到達するか判断する必要がある。 +
詳細は説明しないが、インターネットにアクセスする際はルータと呼ばれる機器に接続することが多い。 +
ルータは複数のネットワークと相互に接続しており、どのIPアドレスの範囲がどのケーブルに対応するかを内部に保持している。 +
特定のIPアドレスに対するアクセスがあった際は、そのテーブルを参照し、情報を伝達する。 +
一つのルータ内に全てのIPアドレスの情報を持つことは現実敵ではないため、複数のルータを次々リレーしていくことで最終的な目的地に到達する。

[[HowInterWorks_Communication_Protcol_Internet_IP_GlobalPrivate]]
====== グローバルIP/プライベートIP
前述したように、ネットワークに接続するにあたり、各機器はIPアドレスを持たなければならない. +
一方で https://www.soumu.go.jp/johotsusintokei/whitepaper/ja/h30/html/nd111200.html[総務省の平成30年度版情報通信白書]によると、全世界でインターネットに接続できる機器は400億台以上存在すると予想される。 +
現在主流のIPv4では、すべてのアドレスをフルに使えるとしても総アドレス数は43億程度である。 +
この場合、全ての機器に対してIPアドレスを振り分けてしまうと、IPアドレスが重複してしまうことになる。 +
IPアドレスが重複してしまうと通信先を一意に決めることができないため、通信が成立しなくなる。 +
そこで、通常インターネットに接続できる一意なIPアドレス(**グローバルIP**)は個々人のPCなどに対して直接払いだされることはなく、あるネットワーク(LAN/WAN)内でのみ一意である**プライベートIP**を保有し、グローバルIPを持つ機器を経由してネットワークにアクセスする。 +
以下に概要図を示す。 +

概要図に示すように、通常グローバルIPとプライベートIPは1対1から1対多で対応する。 +
プライベートIPを持つ機器からインターネット上の特定の機器にアクセスする際は、前述したように直接インターネットにアクセスするのではなく、通常グローバルIPアドレスが付与されたルータ等の機器を通してアクセスを試みる。 +
この時ルータへの通信内容は目的となる機器のIPアドレス、および自身のプライベートIPが含まれる。 +
ルータはその通信を送信元個別のポート(ポート番号については<<>>で説明を行う)で受信し、送信元を自身の保有するグローバルIPアドレスと任意のポートにマスクして目的のIPアドレスへリクエストを送信する。また、同時に本来の送信元プライベートIPとポート/変換後のIPとポートの情報を自身の中にテーブルとして保持しておく。 +
インターネット上の機器からレスポンスが帰ってくると、ルータは自身の中に保存したテーブルを参照し、どのプライベートIPに対応するか確認し、レスポンスを転送する。 +
この技術を**NAPT(ネットワークアドレス変換)**と呼ぶ。 +
全43億のIPアドレスのうち、下記の範囲のIPアドレスはプライベートIPとして使用することを想定されている。 +

.プライベートIPアドレス
[cols="60,40", options="header"]
|===
|IPアドレス範囲
|アドレス数

|10.0.0.0 – 10.255.255.255
|約1700万

|172.16.0.0 – 172.31.255.255
|約100万

|192.168.0.0 – 192.168.255.255
|約6万5000
|===

プライベートIPは、別のWANやLANでは重複しても問題ないため、インターネットに接続可能な機器の数を増やすことができる。 +

グローバルIPをどの機器に振り分けるかは全て管理団体によって管理されている。 +
全世界的には https://www.iana.org/[IANA]が管理し、国/地域に対して振り分けるIPを管理し、国/地域内では各地域の管理団体(アジアでは https://www.apnic.net/[APNIC] 日本では https://www.nic.ad.jp/ja/[JPNIC]が管轄)が管理し、NTTなどに代表される国内のISP(Internet Service Provider)に対し割り振る。 +
通常の家庭では、ISPと契約した際に割り当てられたグローバルIPを持つ機器を通じてインターネットにアクセスすることができるようになる。 +

[[HowInterWorks_Communication_Protcol_Internet_IP_Subnet]]
====== サブネット

==== トランスポート層
===== TCP

==== アプリケーション層
===== DNS
===== FTP
===== HTTP
===== TLS/SSL
===== SSH

== インターネット通信の実践
=== プロキシサーバ