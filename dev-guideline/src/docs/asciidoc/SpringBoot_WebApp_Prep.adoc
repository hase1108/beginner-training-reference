include::include_all.adoc[]

:toclevels: 5
:sectnums:

[SpringBootWebApp]
= SpringBootでのWebアプリケーション作成準備

[[SpringBootWebAppPrep_Overview]]
== OverView
<<WebApplication.adoc#WebApplication,WebApplicationとは>>で説明したように、アプリケーションの一形態としてWebアプリケーションは広範に用いられている。 +
本章では、非常に簡単なTodo管理アプリをJavaのフレームワークの一つである**SpringBoot**を用いて開発することを通じて、実際にWebアプリケーションの開発観点を学ぶ。 +
今回はアプリケーション開発を行う前の設計や事前知識、開発環境の整理などを行う。 

[[SpringBootWebAppPrep_Design]]
== Webアプリケーションの設計
どのような形式のアプリケーションでも、いきなりアプリケーションを作成する前にアプリケーションがどのような機能を持つのか、どのような仕組みで動作するのかを決定する必要がある。 +
通常、アプリケーションの設計は以下の順番で行われる。 +

* 要件定義 : システムに期待する機能、目的の明確化、システムの実現手段の決定
* 基本設計 : 業務フローの確定、DBのテーブル定義、機能一覧の作成
* 詳細設計 : 実際にプログラムに落とし込むための詳細設計書の作成

本節ではTodoアプリの簡単な設計を通じてそれぞれの段階で何をやるのかを学ぶ。 +
なお、通常は各段階でそれぞれ設計書や仕様書などの書類を作成するが、設計書や仕様書の枠組みなどはそれぞれの現場で異なることが多いため、今回は具体的に設計書は作成せず、どういった内容が記述されるかを記載するに留める。 +
実際の現場では、仕様書や設計書の枠組みに合わせ、記述する内容を微妙に変化させる必要があることを心に留めておいていただきたい。

[[SpringBootWebAppPrep_Design_Business]]
=== 要件定義
通常アプリケーション作成の一番最初に行われるのが**要件定義**である。 +
要件定義は一言でいえば、``クライアントもしくはユーザの要望のまとめ``また``その要望をどのように実現するかの青写真``を作成するステップになる。 +
要件定義を更に細かいステップに分けると以下のようになる。 +

* クライアント/ユーザの要求のヒアリング
* システムの課題/目的/方針の決定
* システム概要/機能/範囲の決定
* UIなどのイメージの構想決定
* システム構成の決定
* 導入/移行/運用/保守方針の決定
* スケジュール/人員の決定
* 成果物の決定
* 作業標準/品質管理方針の決定

見てわかるように、アプリケーション開発において、大きな方針はここで決められる。 +
特に、アプリケーションの持つ機能とシステム構成が決まってしまえば、どのようにアプリケーションを実装するかは概ね決まってしまうため、実装段階でこの部分が大きくぶれるとスケジュールなどに多大な影響を被る場合が多い。 +
しかしながら、往々にしてこの段階で気づかなかった問題が実装段階で判明することもよくある。 +

今回作成するTodoアプリでは、要求のヒアリングや導入/移行方針の決定などは行えないため、以下の内容に絞って記述していく。

* システム概要/機能/範囲の決定
* システム構成の決定

[[SpringBootWebAppPrep_Design_Business_SysOverview]]
==== システム概要
本システムで行いたい機能は以下の通りである。 +

* ユーザはWebクライアントを通じてシステムにアクセスできる
* システムはJSONを利用して情報をやり取りできる
* ユーザは一人しか使用しないため、ログインなどの機能は作成しない
* ユーザはタスクを登録することができる。
** タスクはタイトルとタスクが完了したかどうかの情報を持つ
** 登録できるタスクは5つまでである
** 登録した際のタスクは常に未完了状態である
** タスクは未完了状態から完了状態に変化できるが、逆はできない
** タスクは削除することができる
* ユーザはタスクの一覧を取得することができる
** タスクの一覧は完了未完了問わずすべて表示される
* タスクの情報はDBには保存せず、アプリケーション内で保持する

[[SpringBootWebAppPrep_Design_Business_SysConstitution]]
==== システム構成
本システムは最終的にはAWS上のEC2インスタンス上で動作させる。 +
最終的な構成は以下のようになる。

.システム構成図
[#Diagram]
image::SpringBoot_WebApp/SystemConfigDiagram.png[システム構成図]

AWSの構成についての詳しい説明は後述する。 +
なお、あくまで学習用途用のアプリケーションの為、この構成のまま実務に使用することはできない。

[[SpringBootWebAppPrep_Design_Basic]]
=== 基本設計
要件定義が終了した後、要件定義で確認した仕様をもとに業務の整理や利用するDBのテーブル設計などを行うのが基本設計になる。 +
基本設計をより細かいステップに分けると以下のようなタスクがある。 +

* 業務フロー作成
* 機能一覧作成
* 画面/帳票レイアウト作成
* 画面遷移図作成
* ER図/CRUD図作成
* システムインターフェース作成

本システムはREST APIを実装したWebアプリケーションであり、またDBを用いない為、ER図などは作成しない、以下の項目について簡単に設計する。 +

* 業務フロー
* 機能一覧
* システムインターフェース

[[SpringBootWebAppPrep_Design_Basic_Flow]]
==== 業務フロー
業務フローは要件定義で決定した各仕様/機能に対して実際にどのような処理をどのような順番で、誰/何に対して行うかをフローチャートとして図示したものになる。 +
システムの規模によっては関連する部署、システムが非常に大きくなることもあるため、このような業務フローを作成して関係者間で合意を得る必要がある。 +

本来であれば、**スイムレーン**と呼ばれる部署/担当ごとにどの機能を担当するかを示す記法を用いることが多いが、今回作成するTodoアプリは利用するユーザとWebアプリケーションしか存在しないため省略する。 +

.タスク投稿
[#CreateTask]
image::SpringBoot_WebApp/Create_Task.png[タスク投稿]

.タスク取得
[#ReadTask]
image::SpringBoot_WebApp/Read_Task.png[タスク取得]

.全タスク取得
[#ReadTaskList]
image::SpringBoot_WebApp/Read_Task_List.png[全タスク取得]

.タスク削除
[#DeleteTask]
image::SpringBoot_WebApp/Delete_Task.png[タスク削除]

.タスク更新
[#UpdateTask]
image::SpringBoot_WebApp/Put_Task.png[タスク更新]


フローチャートなどを作成するツールは様々存在するが、今回はlink:https://plantuml.com/ja/[plantUML]のアクティビティ図作成機能を利用して記述している。 +
Webアプリケーションではlink:https://app.diagrams.net/[draw.io]などが知られるが、Webアプリケーションであるため業務上センシティブな情報を記述する必要がある場合は使用しないこと。

[[SpringBootWebAppPrep_Design_Basic_Features]]
==== 機能一覧
業務フローを作成した後、開発対象となる機能を一覧として記述し、システム化の対象を明確にする。 +
本来であれば、一つのシステム内で共通的に利用する機能などがあるため、そういった部分の重複を防ぐためにも行う必要があるが、今回作成するシステムは機能がシンプルで業務フロー自体がほぼ機能を示しているためため作成しない。


[[SpringBootWebAppPrep_Design_Basic_IF]]
==== インターフェース
機能一覧を整理したのちとりかかるのが**インターフェース**部分の設計である。
インターフェースとは、システムにおけるユーザとの入出力部分に相当する。 +
インターフェースを設計する際はそのインターフェース部分に対して入出力先や入出力を行うデータの種類を設計することになる。 +
同じような言葉として**エンドポイント**という語もある。 +

本システムでは、ユーザはシステムの特定のパスに対してアクセスすることで機能を利用することになるため、今回の場合はパスがインターフェースに相当する。 +
通常、RESTの思想で作成したシステムのインターフェースは**REST API**と呼ばれる。 +
本システムのインターフェースは簡単にまとめると以下のようになる。 +
なお、REST APIのURL設計は様々な考え方が存在する為、システムで決定した方針に従って決定すること。

.Todoアプリインターフェース
[cols="10,10,20,40,50", options="header"]
|===
|項目名
|パス
|メソッド
|入力項目
|出力項目

|タスク投稿
|/todos
|POST
|taskTitle:String
|taskId:int +
taskTitle:String +
isFinished:boolean

|タスク取得
|/todos/{id}
|GET
|-
|taskId:int +
taskTitle:String +
isFinished:boolean

|タスクリスト取得
|/todos
|GET
|-
|taskId:int +
taskTitle:String +
isFinished:boolean

|タスク削除
|/todos/{id}
|DELETE
|-
|-

|タスク更新
|/todos/{id}
|PUT
|-
|-
|===

[[SpringBootWebAppPrep_Design_Detail]]
=== 詳細設計
基本設計書で大まかにシステムで開発を行う範囲や機能が決まったところで、それを実際にプログラムに落とし込むために詳細設計を行う必要がある。 +
詳細設計ではよりプログラム的な考え方に寄っていくことになり、主に以下のような事柄について設計する。 +

* 機能設計書
* DBの物理設計書
* メッセージ
* 画面項目
* 例外設計
* セキュリティ対策

詳細設計所は、製造段階だけでなく運用管理や保守の際も用いられることが多い。 +
今回の開発では詳細設計書を作成するほどの規模でもないため省略する。 +

[[SpringBootWebAppPrep_DevEnv]]
== 開発環境整理
システム開発を行うに当たり、通常各個人のローカルでの開発のみで完結することはなく、目的によって様々なシステムやツールを使用して効率的に開発/管理を行う事が多い。 +
目的や代表的なツールをまとめたものを以下に示す。 +

.開発環境
[cols="20,60,20" options="header"]
|===
|目的
|概要
|代表的なツール

|コーディング支援
|主にエディタの機能に加え、デバッガや入力補完などコーディングをする際にプログラマの負担を軽減する役目を持つ。
|STS, VSCode

|プロジェクト/ライブラリ管理
|コンパイル、テスト実行やデプロイ、実行ファイルの作成、ライブラリの管理などを行う。
|Maven, Gradle

|ソースコード管理
|複数人で同じシステムの開発をする際に、コーディングした内容を管理するために利用する。
|Git, SVN

|タスク管理
|コーディング作業のみならず、システム開発全体のタスクを管理する。
|RedMine, Trello

|CI/CD
|自動的なテスト実行やデプロイなどを行う。
|Jenkins, CircleCI

|品質管理
|静的にソースコードを解析し、含まれるバグの数などを管理する。
|FindBugs, CheckStyle
|===

これらのツールは確かに利用すると便利であるが、そもそもセットアップ自体が面倒であったり、プロジェクトの規約で使用できない場合も多く、必ず客先と合意をとる必要がある。 +
また、表記したツール以外にも様々な種類が存在し、ツールによって使用方法が大きく変わる場合があるため注意が必要である。 +

本システムは規模が大きくない上開発担当も一人しかいないため、最低限の開発環境で行う。 +
具体的には以下のツールを利用する。 +

* STS
* Maven
* Git

STSに関しては前章で利用したため説明は省く。 +
MavenとGitについては以下で説明する。 +

[[SpringBootWebAppPrep_DevEnv_Maven]]
=== Maven
**MAven**はいわゆるJavaプログラム向けビルドツールの一つで、今までJavacコマンドやJavaコマンドで行っていたコンパイルや実行、その他テストや利用するライブラリのバージョン管理をxmlで記述したテキストを基に管理できるようになる。 +
また、基本的な機能以外にも様々なプラグインを利用することもできる。 +
なお、利用するにあたってはJavaの実行環境が必要になる。 +
MavenはSpringBootを利用する際のビルドツールとしては有名で、STSでもデフォルトでMavenを利用することができる。 +


MavenはApache財団が管理しており、アプリケーション自体はlink:https://maven.apache.org/download.cgi[こちら]からダウンロードできる。 +
ダウンロード後はJDKのインストールと同様に適当なディレクトリにzipを解凍し、環境変数にbinまでのパスを登録すればよい。 +
コマンドプロンプトから``mvn --version``と入力し、下記のように表示されたらインストール成功である。 +

.Maven
[#Maven]
image::SpringBoot_WebApp/maven_install.png[Maven]

Mavenの詳しい機能に関しては後述する。 +

[[SpringBootWebAppPrep_DevEnv_Git]]
=== Git
Gitはソースコードなどのファイル類の変更履歴やバージョン管理を行うことを目的に作成された分散型のバージョン管理システムである。 +
多くのプロジェクトで利用されており、現状デファクトスタンダードである。 +

Gitの概要図を以下に示す。 +

.Gitの概要
[#GitOverview]
image::SpringBoot_WebApp/Git_Overview.png[Gitの概要]

Gitでは、ソースコードなどの管理対象のファイルは**リポジトリ**で管理される。 +
リポジトリは通常サーバなどに建てられた**リモートリポジトリ**と各個人のコンピュータ内に作成された**ローカルリポジトリ**の二種類を用いる。 +
基本的に各個人の作業はローカルリポジトリに対して行われ、リモートリポジトリは各開発者の変更すべてを管理することになる。 +
ローカルリポジトリとリモートリポジトリは``push``及び``pull``で同期をとる。 +
これだけではサーバのファイルに対して各開発者が編集するのとあまり変わらないが、Gitでは**ブランチ**および**コミット**を利用することで複数開発者が同じプロジェクトに対して同時に変更をかけたり、バグ修正を円滑に行うことができる。 +

ブランチ及びコミットに関して以下に概要図を示す。 +

.Branch/Commitの概要
[#Branch]
image::SpringBoot_WebApp/Branch.png[Branch/Commitの概要]

開発者がバグの修正や機能の追加を行う際は、もととなるプロジェクトに対してブランチを切り、切り分けたブランチに対して修正を加える。 +
ブランチを分けるとその修正はブランチをマージするまで取り込まれることはない。 +
マージをする前に他の開発者の修正がマージされ、修正内容が衝突してしまった場合は、警告がでて修正を行うことができる。 +
修正はコミット単位で行われ、不要な修正をしてしまったりした際はそのコミットを打ち消すこともできるし、必要なコミットのみ取得することもできる。 +

ブランチの切り方やコミットの単位は色々な思想がある。 +
Git-flowやGitHub-Flowなどが有名だが、それぞれのプロジェクトで採用されている方式に合わせる。 +

具体的にGitを用いた管理方式に関しては後述する。 +
Gitのアプリケーションはlink:https://git-scm.com/downloads[こちら]からダウンロードし、取得したインストーラを用いてインストールすることができる。 +
``git --version``でGitのバージョン情報が表示されたらインストールが成功している。 +

[[SpringBootWebAppPrep_SpringBoot]]
== SpringBoot
今回作成するTodoアプリケーションを作成するにあたり、当然様々な機能をソースコードを記述する必要があるが、Httpによる接続部分の実装や、各種DBの操作などを自分で実装するのは現実的ではない。 +
Webアプリケーションに限らないが、通常ソフトウェア開発ではそのように普遍的な機能の部分は独自で実装する事はなく、**フレームワーク**を用いる事が多い。 +
フレームワークはその名の通り一般的なアプリケーションの形態の枠組み部分を独自に実装したライブラリの集まりのような形式をしており、開発者はアプリケーション独自のビジネスロジックなどの特定部分の実装にのみ集中すれば良いような仕組みになっている。 +
イメージを以下に示す。 +

.FrameWorkのイメージ
[#FrameWork]
image::SpringBoot_WebApp/FrameWork.png[FrameWorkのイメージ]

上記のイメージで言えば、実際にインターネットのリクエストを最初に受ける部分やDBの接続部分に関してはフレームワーク側で用意されており、開発者はパラメータなどを設定するのみで実際にコーディングする必要はない。 +
そのためビジネスロジック部分の実装に集中することができる。 +

今回のWebアプリケーションでは、Javaのフレームワークとして有名な**SpringBoot**を利用して開発を行う。 +
SpringBootを利用するにあたり、特徴的な機能である**DI(Dependency Injection)**について説明する。

[[SpringBootWebAppPrep_SpringBoot_DI]]
=== DI(Dependency Injection)
まず、前提として**DI(Dependency Inhection)**はソフトウェアパターンの一種であり、SpringBoot特有の機能ではない。 +
しかしながら、SpringBootでシステム開発を行う上でこの機能を利用することを前提としているため説明する。 +

システム開発では、複雑な機能やビジネスロジックを実装するために、膨大なクラスを実装し、そのそれぞれが相互に連携する。 +
この時、一部のクラスの実装方式が変更してクラス外からの利用方法が変化してしまうと、そのクラスを利用しているクラスへの影響が大きい事が予想される。 +
また、開発の進行度合いによっては、あるクラスで使用される予定であるクラスを未実装のままで開発していく必要が出てくる。 +
通常、このようにシステム内で定義されているクラス間の関連性が深く、一部の変更による影響度が高い状態のものを**密結合**の状態と言われる。 +
そこで、DIではクラス間の密結合状態を排除するために、クラスの依存性をxmlやアノテーションで記述することで、実際に利用するクラスを後で容易に変えられるようにする。 +

具体的にはDIで利用されるクラスはプログラム実行時に**DIコンテナ**にインスタンスとして保持され、各クラスで利用される際にアノテーションやxmlで記述された依存性に従ってインジェクション(注入)する。 +
インジェクションされるクラスでは、特定のインターフェースを実装したクラスを利用する前提クラスを実装することで、同じインターフェースを実装したものであれば動作に差支えがない状態になる。 +
また、テスト実行時などではインジェクションするクラスをモックとして置くことで、未実装の状態でも容易にテストができるようになる。 +
イメージ図を以下に示す。 +

.DIのイメージ
[#DI]
image::SpringBoot_WebApp/DI.png[DIのイメージ]

実際にどのようにSpringBootで利用するかは後述する。